<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CHARLES // SECURE_CORE v73</title>
    </head>
<body>
    <script>
    let isAdmin = false;

    // --- NEW SECURE CHAT LOGIC ---
    async function askCharles(userText) {
        try {
            const response = await fetch("/.netlify/functions/charles", {
                method: "POST",
                body: JSON.stringify({ 
                    message: userText, 
                    isAdmin: isAdmin 
                })
            });
            const data = await response.json();
            return data.reply;
        } catch (e) {
            return "My connection to the back office is severed. Fix it, JOse.";
        }
    }

    // --- INPUT HANDLER ---
    document.getElementById('userInput').addEventListener('keypress', async (e) => {
        if(e.key === 'Enter' && e.target.value) {
            const val = e.target.value;
            addMsg(val, 'user');
            e.target.value = '';

            // Guest Trap (Rewrite check)
            if (val.toLowerCase().includes("rewrite") && !isAdmin) {
                addMsg("Unauthorized. Goodbye.", "ai");
                setTimeout(() => { document.body.innerHTML = "<h1>LOCKED</h1>"; }, 2000);
                return;
            }

            // Call the secure function
            const reply = await askCharles(val);
            addMsg(reply, 'ai');
        }
    });

    // [Rest of launch/admin logic from v72]
</script>
</body>
</html>